<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stories Widget</title>
  <style>
    :root {
      --bg: #0e0f11;
      --fg: #f5f7fa;
      --muted: #a5adba;
      --card: #171a1f;
      --accent: #6ea8fe;
      --radius: 16px;
      --shadow: 0 2px 10px rgba(0,0,0,.25);
    }
    html, body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; margin: 4px 0 12px 0; }
    header h2 { font-size: 1.1rem; margin: 0; font-weight: 600; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 14px;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,.35); }
    .thumb {
      width:100%; aspect-ratio: 16/9; object-fit: cover; display:block; background:#222;
    }
    .content { padding: 10px 12px 12px 12px; }
    .title { font-size: .98rem; line-height: 1.35; margin: 0 0 6px 0; }
    .title a { color: var(--fg); text-decoration: none; }
    .title a:hover { text-decoration: underline; }
    .meta { color: var(--muted); font-size: .8rem; margin-bottom: 4px; }
    .footer { text-align:center; margin: 16px 0 8px 0; font-size: .9rem; }
    .footer a { color: var(--accent); text-decoration: none; }
    .sr-only { position:absolute; left:-9999px; }
  </style>
</head>
<body>
  <div class="wrap" id="app" role="region" aria-label="Latest stories">
    <header>
      <h2>Latest Stories</h2>
      <div class="meta" id="countLabel"></div>
    </header>
    <div class="grid" id="grid" aria-live="polite"></div>
    <div class="footer">
      <a id="viewAll" href="#" target="_blank" rel="noopener">View all</a>
    </div>
  </div>

  <script>
  // ---- Config (defaults tailored to your ask) -------------------------------
  const params  = new URLSearchParams(location.search);
  const FEED_URL = "https://anjaleeds.github.io/story-feed/feed.xml";
  const FEED_VER = "v=2"; // bump when you push updates
  const feedUrl = FEED_URL + (FEED_URL.includes("?") ? "&" : "?") + FEED_VER;

  fetch(feedUrl, { cache: "no-store" })
    .then(r => r.text())
    .then(xmlText => {
      // existing parsing code below
    });
    
  const COUNT    = Math.max(1, Math.min(24, parseInt(params.get('count') || '99', 10)));  
  const THEME    = (params.get('theme') || 'dark').toLowerCase();                        // default dark
  document.documentElement.setAttribute('data-theme', THEME);

  // ---- Utilities ------------------------------------------------------------
  function postHeight() {
    const h = document.documentElement.scrollHeight;
    parent.postMessage({ type: 'widget-size', height: h }, '*');
  }
  const decodeHTMLEntities = (str) => { const t = document.createElement('textarea'); t.innerHTML = str || ''; return t.value; };
  const extractFirstImg = (html) => {
    if (!html) return null;
    const m = html.match(/<img[^>]+src=["']([^"']+)["']/i);
    return m ? m[1] : null;
  };
  const stripTags = (html) => (html || '').replace(/<[^>]*>/g, '').trim();

  // ---- Load & render --------------------------------------------------------
  async function load() {
    try {
      const res = await fetch(FEED_URL, { cache: 'no-store' });
      const xml = await res.text();
      const doc = new DOMParser().parseFromString(xml, 'application/xml');

      const channelLink = doc.querySelector('channel > link')?.textContent?.trim() || FEED_URL;
      document.getElementById('viewAll').href = channelLink;

      let items = [...doc.querySelectorAll('channel > item')].map((it) => {
        const title = it.querySelector('title')?.textContent?.trim() || 'Untitled';
        const link  = it.querySelector('link')?.textContent?.trim() || '#';
        const pub   = it.querySelector('pubDate')?.textContent?.trim() || '';
        const desc  = it.querySelector('description')?.textContent || '';
        const decoded = decodeHTMLEntities(desc);
        const img = extractFirstImg(decoded);
        const text = stripTags(decoded).slice(0, 200);
        return { title, link, pub, img, text, ts: Date.parse(pub || 0) || 0 };
      });

      // Sort newest â†’ oldest using pubDate
      items.sort((a, b) => b.ts - a.ts);

      // Take the first COUNT items
      items = items.slice(0, COUNT);

      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      items.forEach(({ title, link, pub, img, text }) => {
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          ${img ? `<a href="${link}" target="_blank" rel="noopener">
                      <img class="thumb" src="${img}" alt="" loading="lazy">
                    </a>` : ''}
          <div class="content">
            <h3 class="title"><a href="${link}" target="_blank" rel="noopener">${title}</a></h3>
            <div class="meta">${pub ? new Date(pub).toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' }) : ''}</div>
          </div>
        `;
        grid.appendChild(card);
      });

      document.getElementById('countLabel').textContent = `${items.length} shown (newest first)`;
      // Resize messages for Squarespace iframe
      postHeight(); setTimeout(postHeight, 50); setTimeout(postHeight, 300); setTimeout(postHeight, 1000);
    } catch (e) {
      document.getElementById('grid').innerHTML = `<p>Failed to load feed.</p>`;
      postHeight();
    }
  }
  window.addEventListener('load', load);
  </script>
</body>
</html>
