<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Story Feed</title>
  <style>
    :root {
      --bg: #0d0f11;
      --fg: #f5f6f7;
      --card: #181b20;
      --accent: #7aa2ff;
      --muted: #8b93a3;
      --radius: 16px;
      --shadow: 0 4px 16px rgba(0,0,0,.4);
    }
    * { box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, sans-serif;
      margin: 0;
      padding: 24px;
      display: grid;
      gap: 24px;
      justify-content: center;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
      max-width: 1300px;
      width: 100%;
    }
    article {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    article:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0,0,0,.6);
    }
    .thumb {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
      background: #0f1216;
    }
    .inner { padding: 16px 20px; }
    h2 {
      font-size: 1.1rem;
      margin: 0 0 8px 0;
      color: var(--accent);
    }
    p.desc {
      font-size: .95rem;
      color: var(--muted);
      line-height: 1.4;
      margin: 0;
    }
    .skeleton {
      animation: pulse 1.3s infinite ease-in-out;
      background: linear-gradient(90deg, #121519, #151a20, #121519);
      background-size: 200% 100%;
    }
    @keyframes pulse {
      0%{background-position:0% 0}
      100%{background-position:-200% 0}
    }
  </style>
</head>
<body>
  <div class="grid" id="grid"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const FEED_URL = "https://anjaleeds.github.io/story-feed/feed.xml";
    const FEED_VER = "v=32"; // bump when updating
    const feedUrl  = FEED_URL + (FEED_URL.includes("?") ? "&" : "?") + FEED_VER;
    const COUNT    = Math.min(99, Number(params.get("count") || 8));
    const FEED_BASE = "https://anjaleeds.github.io/story-feed/";

    const absolutize = (url, base) => new URL(url, base).href;

    function fixPostLink(url) {
      if (!url) return "#";
      const u = new URL(url, FEED_BASE);
      if (u.pathname.startsWith("/posts/")) {
        u.pathname = "/story-feed" + u.pathname;
      }
      return u.href;
    }

    function loadImageWithRetry(imgEl, baseUrl, maxTries = 5) {
      let tries = 0;
      function attempt() {
        const url = baseUrl + (baseUrl.includes("?") ? "&" : "?") + "v=" + Date.now();
        imgEl.src = url;
      }
      imgEl.addEventListener("error", () => {
        tries++;
        if (tries < maxTries) {
          const backoff = Math.min(1500 * Math.pow(1.6, tries), 6000);
          setTimeout(attempt, backoff);
        } else {
          console.warn("Image failed after retries:", baseUrl);
        }
      });
      attempt();
    }

    // Fetch and render
    fetch(feedUrl, { cache: "no-store" })
      .then(r => r.text())
      .then(xmlText => {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "application/xml");
        const allItems = Array.from(xml.querySelectorAll("item"));
        const items = allItems.slice(-COUNT).reverse();
        const grid = document.getElementById("grid");

        for (const item of items) {
          const rawLink = item.querySelector("link")?.textContent || "#";
          const link = fixPostLink(rawLink);
          const desc = item.querySelector("description")?.textContent || "";
          const title = item.querySelector("title")?.textContent || "Untitled";

          const enc = item.querySelector("enclosure");
          let img = enc?.getAttribute("url") || null;
          if (!img) {
            const m = desc.match(/<img[^>]+src=['"]([^'"]+)['"]/i);
            if (m) img = m[1];
          }
          if (img) img = absolutize(img, FEED_BASE);

          const safeText = desc.replace(/<[^>]+>/g, "").trim().slice(0, 80);
          const card = document.createElement("article");
          card.innerHTML = `
            ${img ? `<a href="${link}" target="_blank" rel="noopener">
              <img class="thumb skeleton" alt="${title}">
            </a>` : ""}
            <div class="inner">
              <h2><a href="${link}" target="_blank" rel="noopener" style="color:inherit;text-decoration:none;">${title}</a></h2>
              <p class="desc">${safeText}${safeText.length === 80 ? "â€¦" : ""}</p>
            </div>
          `;
          grid.appendChild(card);

          if (img) {
            const imgEl = card.querySelector(".thumb");
            loadImageWithRetry(imgEl, img);
            imgEl.addEventListener("load", () => imgEl.classList.remove("skeleton"), { once: true });
          }
        }

        postSize();
      })
      .catch(err => {
        console.error("Feed load error:", err);
        postSize();
      });

    // --- Auto resize ---
    function measureHeight() {
      const b = document.body;
      const d = document.documentElement;
      return Math.max(
        b.scrollHeight, b.offsetHeight, b.clientHeight,
        d ? d.scrollHeight : 0, d ? d.offsetHeight : 0, d ? d.clientHeight : 0
      );
    }

    let lastH = 0, rafId = null;
    function postSize() {
      if (rafId) return;
      rafId = requestAnimationFrame(() => {
        rafId = null;
        const h = measureHeight();
        if (h !== lastH) {
          lastH = h;
          window.parent.postMessage({ type: "widget-size", height: h }, "*");
        }
      });
    }

    window.addEventListener("load", postSize);
    window.addEventListener("resize", postSize);

    const ro = new ResizeObserver(postSize);
    ro.observe(document.body);

    const mo = new MutationObserver(postSize);
    mo.observe(document.body, { childList: true, subtree: true, attributes: true });

    for (const img of document.images) {
      if (!img.complete) img.addEventListener("load", postSize, { once: true });
    }

    setTimeout(postSize, 0);
  </script>
</body>
</html>
