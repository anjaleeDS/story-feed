<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stories Widget</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #666;
      --card: #f7f7f7;
      --accent: #1a73e8;
      --radius: 16px;
    }
    [data-theme="dark"] {
      --bg: #0e0f11;
      --fg: #f5f7fa;
      --muted: #a5adba;
      --card: #171a1f;
      --accent: #6ea8fe;
    }
    html, body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }
    header {
      display:flex; align-items:center; justify-content:space-between;
      margin: 4px 0 16px 0;
    }
    header h2 {
      font-size: 1.25rem; margin: 0;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
      transition: transform .15s ease;
    }
    .card:hover { transform: translateY(-2px); }
    .thumb {
      width:100%; aspect-ratio: 16/9; object-fit: cover; display:block; background:#ddd;
    }
    .content { padding: 12px 14px 16px 14px; }
    .title {
      font-size: 1rem; line-height: 1.35; margin: 0 0 6px 0;
    }
    .meta { color: var(--muted); font-size: .85rem; margin-bottom: 8px; }
    .content a { color: var(--accent); text-decoration: none; }
    .footer {
      text-align:center; margin: 18px 0 8px 0; font-size: .9rem;
    }
    .sr-only { position:absolute; left:-9999px; }
  </style>
</head>
<body>
  <div class="wrap" id="app" role="region" aria-label="Latest stories">
    <header>
      <h2>Latest Stories</h2>
      <div class="meta" id="countLabel"></div>
    </header>
    <div class="grid" id="grid" aria-live="polite"></div>
    <div class="footer">
      <a id="viewAll" href="#" target="_blank" rel="noopener">View all</a>
    </div>
  </div>

  <script>
  // ---- Config via query params ---------------------------------------------
  const params = new URLSearchParams(location.search);
  const FEED_URL = params.get('feed') || 'https://anjaleeds.github.io/story-feed/feed.xml';
  const COUNT    = Math.max(1, Math.min(24, parseInt(params.get('count') || '6', 10)));
  const THEME    = (params.get('theme') || 'light').toLowerCase(); // 'light' | 'dark'
  const SHOWDESC = (params.get('showdesc') || '0') === '1';
  document.documentElement.setAttribute('data-theme', THEME);

  // ---- Utilities ------------------------------------------------------------
  function postHeight() {
    // Send height to parent so the iframe can auto-resize
    const h = document.documentElement.scrollHeight;
    parent.postMessage({ type: 'widget-size', height: h }, '*');
  }
  const decodeHTMLEntities = (str) => {
    const txt = document.createElement('textarea'); txt.innerHTML = str; return txt.value;
  };
  const extractFirstImg = (html) => {
    if (!html) return null;
    const m = html.match(/<img[^>]+src=["']([^"']+)["']/i);
    return m ? m[1] : null;
  };
  const stripTags = (html) => (html || '').replace(/<[^>]*>/g, '').trim();

  // ---- Render ---------------------------------------------------------------
  async function load() {
    try {
      const res = await fetch(FEED_URL, { cache: 'no-store' });
      const xml = await res.text();
      const doc = new DOMParser().parseFromString(xml, 'application/xml');

      const channelLink = doc.querySelector('channel > link')?.textContent?.trim() || FEED_URL;
      document.getElementById('viewAll').href = channelLink;

      const items = [...doc.querySelectorAll('channel > item')].slice(0, COUNT).map((it) => {
        const title = it.querySelector('title')?.textContent?.trim() || 'Untitled';
        const link  = it.querySelector('link')?.textContent?.trim() || '#';
        const pub   = it.querySelector('pubDate')?.textContent?.trim() || '';
        const desc  = it.querySelector('description')?.textContent || '';
        const decoded = decodeHTMLEntities(desc);
        const img = extractFirstImg(decoded);
        const text = stripTags(decoded).slice(0, 240);
        return { title, link, pub, img, text };
      });

      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      items.forEach(({ title, link, pub, img, text }) => {
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          ${img ? `<a href="${link}" target="_blank" rel="noopener">
                      <img class="thumb" src="${img}" alt="" loading="lazy">
                    </a>` : ''}
          <div class="content">
            <h3 class="title"><a href="${link}" target="_blank" rel="noopener">${title}</a></h3>
            <div class="meta">${new Date(pub).toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' })}</div>
            ${SHOWDESC ? `<p>${text}…</p>` : ''}
            <a href="${link}" target="_blank" rel="noopener" aria-label="Read ${title}">Read →</a>
          </div>
        `;
        grid.appendChild(card);
      });

      document.getElementById('countLabel').textContent = `${items.length} shown`;
      postHeight();
      setTimeout(postHeight, 50);
      setTimeout(postHeight, 300);
      setTimeout(postHeight, 1000);
    } catch (e) {
      document.getElementById('grid').innerHTML = `<p>Failed to load feed.</p>`;
      postHeight();
    }
  }
  window.addEventListener('load', load);
  </script>
</body>
</html>
